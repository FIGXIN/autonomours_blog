- [从零开启自动驾驶工程师之路（六）| 规划_SOA开发者的博客-CSDN博客](https://blog.csdn.net/weixin_45576679/article/details/123203511?spm=1001.2014.3001.5502)

![img](https://img-blog.csdnimg.cn/img_convert/b3c972f9a7bbdcb26ac13fd0df0112da.png)



这一系列的第六篇文章我们来聊聊规划。

这就好像你预测了股市未来的走势，自然想去布局规划一番，在那个时间点买入卖出合适。虽然你也知道这预测非常不靠谱，但总想规划一番。

扯远了~[自动驾驶](https://so.csdn.net/so/search?q=自动驾驶&spm=1001.2101.3001.7020)也是如此，好不容易对周围的环境完成了建模和预测，接下来就是规划你的行驶路线了。

规划可真是门大学问。这不，瞄了一眼[Apollo](https://so.csdn.net/so/search?q=Apollo&spm=1001.2101.3001.7020)的课程，好家伙，直呼好家伙，其他章节都是几节十几节课，规划这一章直接搞了足足25节课！行吧，那就慢慢学呗。

规划能有这么多章节自然也是有原因的——在Apollo中它被分成两个部分，即**路线规划模块与轨迹规划模块**。

路线规划属于宏观层面，用之前的地图数据生成车辆的可行使路径，这一步就是你手机上的地图软件每天在干的事情。但是它不会细致的告诉你每一步该怎么走，而这个任务就属于轨迹规划。

轨迹规划做的是微观层面的事情，定义好一系列的点，这些点自带速度、角度、时间戳等属性，可谓是奶妈级教程教车辆一步步如何行驶。这样便能避开障碍物并为乘客创造平稳的乘车体验。

## 1.路径规划

我们先来看看路径规划。

路径规划的目标是在地图上找到从A到B的最佳路线。该模块一般需要三个输入：地图、自身位置以及目的地。前两者都可通过之前的感知、定位模块获得，目的地一般由乘客提供。有了这些信息，路径规划便能开始工作，这一搜寻路线的过程被称为**路由**。

显然一开始就上高精地图进行路线规划实在是太复杂了——高精地图的众多数据会让你眼花缭乱以致无法迅速找到那条最佳路线。这时候我们就需要一些抽象简化手段，我们将起始地和目标地设成点，可行驶路线看成边，那只要想办法用线将这两个点连接起来，路线规划不就成了！这种搜索路径的方式就是图搜索。

![img](https://img-blog.csdnimg.cn/img_convert/2fdce40476f9b78301d9cc9530c8640c.png)



对于搜索进行路径规划的算法，计算机可是非常在行。原因无他，只要是重复做一样事情，计算机就会非常得心应手。恰巧，路径规划就是这么一种搜索算法，它会让计算机不断计算网格中一个节点周围的所有节点的到达难度的数值，从而选取出里面最小的那个作为下一个节点。以此类推，直到摸索到终点处，再倒退回去，就找到了两点之间的最优路径。

很显然，这种暴力的算法很浪费计算资源，尤其是在地图增大之后，路径搜索任务将无法进行。那如何进行改进？

这时候就会用到经典的一种**路径规划算法叫A*（A star）算法**。这个算法分两步。第一步，我们需要计算从开始节点到候选节点的成本g，这很容易获得，因为开始节点与“下一跳”的节点是相邻的；第二步，也是关键的一步，我们需要估算从候选节点去往目的地的成本h，这就比较有难度了，因为两者之间还有一段距离，不太好进行计算。一般采用的方式是启发式的估算方法，我们可以通过自定义的方式来求得所需的成本。最后我们将求得的g和h加起来得到f，最佳候选节点便是f值最小的那个节点。不断重复以上过程，我们终将获得从起始点到目的地的稳定路径。

![img](https://img-blog.csdnimg.cn/img_convert/6c7b398b41115e417e2c18138e64ea5c.png)



我们来看一个具体的例子。

在这样的一个有直线和环形的路线图中，想要到达打星的目标点，我们有几种选择。首先我们把路线图抽象为图，通过节点和边来表示，其次我们考虑每一步所耗费的值。在这个路口，车辆有三种选择，直行、左转或右转。由于车辆是靠右行驶，很显然直行和右转都不会耗费什么时间，而左转所需要的cost就会较多。接下来我们再考虑从此处到终点的耗费值，由于直行的话相当于上了一个高架，要从高架上下来才能抵达终点，远比绕弧线所需的时间要多，因此直行又成了一个不划算的选择。

![img](https://img-blog.csdnimg.cn/img_convert/96095aa615a7b2d4cc65580030a27c4d.png)



综上三种选择，我们将g值和h值一叠加便得到了最终的cost。可以看到此时选择右转节点是最省事的，因此右转节点就成了我们下一步要走的点。

以上便是路径规划的及常用规划算法的简要介绍。不过我们都知道，这才只是在宏观层面告诉了汽车选择什么样的路到达目的地，却没有告诉它在碰到其他障碍物时该如何躲避，因此接下来我们就研究每一步该如何走，这就是轨迹规划的内容。

在研究轨迹规划之前，我们先来考虑一个问题——**如何来定义“两物体相撞”？**

用科学性的话来说便是**两个物体在同一时间抵达了空间中的同一点**。

大家可以想想那么多的车祸，其本质便是在相同的时间，两个物体在同一个空间点上相遇了，表现在驾驶行为中就是相撞。

由于汽车行驶我们正常只在路面上行驶，因此我们只考虑横纵二维，空间中的高度可以先不必考虑，但是加入了新的一个维度——时间。因此轨迹规划就不光需要指导车辆延什么路线行驶，还需要指导汽车在某个时间点上到达空间中的某个点，由此我们就创建了三维轨迹，能够保证车辆在行进中的每个点都未被占用。

避撞只是轨迹规划中最基本的要求，除此之外我们还需要确保轨迹尽可能的舒适、平滑，谁都不喜欢坐在左右来回摇摆、刹车油门大开大合的车上。当然，车辆的轨迹还需合乎逻辑和法规，在地面上都是实线的车道就不能进行变道操作，路牌上标明了静止右转就不能规划出一条包含右转的轨迹。

这些要求或者专业一点称之为**约束**，就是规划类问题的求解的前提条件。有了这些约束，我们才能更好的搜寻出一条优秀的轨迹。