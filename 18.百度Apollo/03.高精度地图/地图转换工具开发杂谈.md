- [地图转换工具开发杂谈 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/489677142)

之前就遇到不少人问我，**有没有opendrive转apollo地图的工具**，由于没有亲自尝试过，只知道lgsvl可以导入地图并且转换到不同的格式，但是需要安装整个仿真器，显得比较繁琐，于是就打算参考lgsvl的代码实现自己写一个。

之前有写一个apollo地图可视化展示工具，但是用的人比较少，好在有基础，于是就打算在这个项目的基本上来完成。思路都想好了，先读取opendrive格式的地图，然后填充数据到apollo格式的地图，最后保存就完成了。

## 阅读理解

看起来好像和把大象放到冰箱里分3步一样，足够简单。但是实现的时候在第一步的时候就卡住了，因为opendrive格式的地图文档就有几十页，理解这些元素就非常费劲，如果只是当初看第一遍、第二遍，我估计很快就会放弃掉，无奈之余，也看了下lgsvl的源码，虽然整体上看了个大概，但对地图的理解还是摸棱两可，好在知乎上还有相关的介绍文章，给了不小的提示，虽然懵懵懂懂，也就确认了第一步先把参考线生成好，然后再看其它的。

**这一步非常关键，因为所有的车道都是通过参考线来排列的**，但opendrive的参考线有5类，分别为直线、螺旋线、弧线和三次曲线，直线很好办，直接长度加上角度就可以采样点了，比较麻烦的是螺旋线，开始我本来查阅了一些资料，例如螺旋线用极坐标来表示比较简单，但要转换极坐标到笛卡尔坐标，又要根据长度来求积分，公式我是列出来了，但是如何求解又不知道，后来还是查找参考的示例代码，从c++移植到python下，这个问题就解决了，最后是弧线，由于弧线是等曲率，比较好解决，最后上述这一步基本上花了我差不多2周时间。

等把参考线画出来，基本上就成功了一半。这其中比较难的地方就是在于opendrive规范的阅读理解，因为参考线的描述是在"planView"这个标签中，除了分段以外，还涉及到坐标系的转换，总之如果要我写一个opendrive转换程序，可能大部分情况都会在这个阶段放弃掉。

因此遇到一个新事物，特别是规范之类比较死板的东西，**最好是能够找到通俗易懂的材料或者博客先看下，先从简单的做起**，不然一连看几天文档可能也不一定看的明白，还容易放弃掉。

![img](https://pic2.zhimg.com/80/v2-95879131676bbcb1a7f3ef4217ef193d_720w.jpg)

opendrive地图展示

## 转换过程

解析完了参考线，接下来就是生成车道，虽然车道的生成也很复杂，因为opendrive的车道和参考线之间还加入了offset，并且车道是按照从左到右的顺序排列的，一个道路可能有好几段。虽然说起来复杂，但是相对参考线来说，感觉还是小巫见大巫，还是比较好理解，这里我觉得遇到的最主要的问题是转换程序的结构。

实际上这个问题分为2个层面，**第一个层面是我遇到的问题，第二个层面是我如何处理**。

**最绕的问题就是车道之间的关系**，由于opendrive中车道的参考线的方向和车道的方向有可能是正着，也有可能是反着的，因此理解这块相当头痛，还包括道路之间的关系，以及车道和路口的关系等。解决这个问题，还是遵循上述的思想，先解决简单的，然后解决复杂的，车道之间的关系解决了，然后解决车道和路口的关系，其中路口的最麻烦，incoming的好解决，outcoming的需要自己推导，这里如果记不住，最好用笔画一下相关的顺序，因为真的非常容易混淆。

再回到第二个问题，一开始我采用的是顺序结构，由于是用xml来解析opendrive文件，因此拿到的对象是xml的对象，但由于上述对象之间的关系复杂，越小的对象，越只有自己的信息，比如车道内部的车道，只知道自己的lane_id，但是不知道自己在哪个road，因此传递参数的时候，要传递很多参数，这还是其次，由于xml对象并不能存储对象之间的关系，因此每次要用到的时候都需要从xml对象中去转换生成，比较麻烦，因此顺序结构的代码逻辑异常复杂。

想来想去，最后还是采用先把xml对象，转换为程序对象，然后在根据不同的需求在不同的对象中增加接口，这样可以极大的减少转换部分的逻辑，比如我可以在lane对象中实现根据求当前长度下的宽度的接口，而lane对象已经有计算所需要的参数，没必要每次都从xml去解析，还可以自己增加参数来存储变量，这样程序看起来也相对简洁，不需要反复在代码中写函数读取参数再转换。

因此我先从xml中读取数据，然后根据需求转换为程序对象，然后在前处理和后处理中处理和添加自己需要的对象，最后再在转换程序中根据接口读取并且转换到apollo格式。

这里又引申出另外一个问题，**就是如何设计程序**，比如你可以实现apollo到opendrive，opendrive到apollo，opendrive到autoware，autoware到opendrive或者其它格式，但也可以实现apollo到自定义格式，自定义格式到其它格式，后一个是中心式，减少了每次遇到一种格式就增加二个转换关系，因此我更加倾向于后者。

![img](https://pic4.zhimg.com/80/v2-f3473bbd8ecc5ba935349d44cc2617cb_720w.jpg)

## 总结

实际上，实现过程中还遇到一些问题，比如路口的形状实际上在opendrive中是没有定义的，因此只能自己根据情况来实现，比如我的实现就是根据路口连接的车道的边界点来确定的。整体从功能上来说，目前还有红绿灯的功能没有增加，以及在某些特定的地图，有非常短的车道会采样失败的情况，但整体功能已经实现。

对地图的理解也加深了，比如之前一直不知道road section，现在知道road section的定义了，而且显然opendrive格式的地图设计的更加复杂和合理，虽然有些方面不适合自动驾驶，但是道路元素的定义以及功能的考虑都更胜一筹。