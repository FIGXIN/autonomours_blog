- [超宽带定位技术方法比较 -- 到达时间差（TDoA）和飞行时间测距（ToF）-全迹科技 (ubitraq.com)](https://www.ubitraq.com/uwb060515/)

![超宽带定位技术方法比较 -- 到达时间差（TDoA）和飞行时间测距（ToF）](https://www.ubitraq.com/content/images/size/w2000/2022/06/3.png)

# 一、超宽带（UWB）定位方法简介

超宽带是一种短距离的无线通信技术，但是同时它也可以应用在室内定位当中，跟蓝牙和WIFI定位方法不同，位置信息并不是基于信号强度（RSSI）进行计算，而是通过无线信号的飞行时间（ToF）计算的。信号飞行的速度是光速（固定值），所以只要知道飞行时间就可以计算出两个设备的距离。

超宽带技术分为两种定位方法：到达时间差（TDoA）和飞行时间测距（ToF）。

超宽带设备分为两种角色：标签Tag和基站Anchor；例如在人员定位场景，每个人会佩戴有一个标签，基站会分布在被定位区域的多个位置。

![img](https://www.ubitraq.com/images/news/docs5_content_1.png)

图 1-1 定位系统示意图

## 1.1 飞行时间测距（ToF）

标签和基站之间会通过无线收发至少3次交互之后，可以得到标签和基站之间的距离信息。

以下图中最常用的3消息双向测距方法为例，标签和基站的测距流程如下图所看到，标签可以看做设备A（Device A），基站可以看做设备B（Device B），设备A主动发起第一次测距消息，设备B响应，得到4个时间戳，设备A等待Treply2之后再发起，设备B接收，再得到2个时间戳。因此可以得到如下四个时间差：

##### ~  Tround1

##### ~  Treply1

##### ~  Tround2

##### ~  Treply2

![img](https://www.ubitraq.com/images/news/docs5_content_2.png)

飞行时间计算方法，可以使用如下公式计算：

![img](https://www.ubitraq.com/images/news/docs5_content_3.png)

最后乘以光速就可以得到设备A和B之间的距离。图1-2是得到各个基站的距离之后，标签定位的过程。

标签和各个基站无线信号的交互如下图所示：

![img](https://www.ubitraq.com/images/news/docs5_content_4.png)

图 1-2 标签与各个基站测距TOF流程图

图1-3是根据到各个基站的测距信息，以基站为中心画圆，就可以得到一个交点，交点就是标签的位置。

![img](https://www.ubitraq.com/images/news/docs5_content_5.png)

图 1-3 双向测距方法定位流程图

## 1.2 到达时间差（TDoA）

到达时间差（TDoA）技术，分为有线同步和无线同步，由于有线同步技术对布线和网络的要求较高，成本比较高，因此一般会采用无线同步技术，本文介绍的到达时间差（TDoA）技术都是基于无线同步。

标签将数据包发送到被基站覆盖的区域内，附近的所有基站都会收到标签的无线信号，但不会返回任何无线信号。由于基站与标签的距离间隔不同，因此消息在不同的时刻到达每个基站。这些时间差乘以空间中恒定的光速得到标签和基站之间的距离差，这样就可以形成多点定位计算的基础，从而确定标签的相对坐标。另外该技术的决定性因素是所有基站必须被同步。

基站之间同步和标签定位的无线数据包如下图所示：

![img](https://www.ubitraq.com/images/news/docs5_content_6.png)

图 1-4 基站同步和标签发射定位流程图

得到各个基站的距离差之后，可以画双曲线，同理交点就是标签的位置。

![img](https://www.ubitraq.com/images/news/docs5_content_7.png)

图 1-5 到达时间差方法定位流程图

# 二、优缺点比较

## 2.1 电池寿命

到达时间差（TDoA）技术，标签定位一次只需要发送一次数据，发送一次所用的时间<200us，从而可以将电池的寿命延长数年。

飞行时间测距（ToF），标签必须发射和接收，定位一次需要跟至少三个基站实现测距，需要实现至少9次的数据交互，所以功耗会大大降低。

结论：到达时间差（TDoA）技术更优。

## 2.2 可伸缩性（系统容量）

到达时间差（TDoA）技术，分为上行TdoA和下行TDoA。

1. (1) 上行TDoA，标签只需要发射一次，按照有效数据12个字节计算，发射时间<151us，所以理论上容量可以达到单区域同时定位6622个标签，但是根据ALOHA理论，保证尽可能小的冲撞情况下，只能18%的标签同时工作，也就是6622*18% = 1192个标签可以正常工作。
2. (2) 下行TDoA，标签不需要发射，只需要接收，标签容量可以做到无限，但是标签功耗会大，而且所有的数据在标签汇集，需要标签自身解算或者传送到服务器计算。

飞行时间测距（ToF），得到一次测距数据需要至少3次数据交互，得到一次定位数据需要至少9次数据交互；标签和其他标签之间如果希望不冲突，需要做好时间分配；理论上可以支持100个标签同时工作，但是根据经验，需要留出测距的保护时间，所以一个标签定位刷新率5赫兹的情况下，同时工作的标签不会超过10个。

结论：到达时间差（TDoA）技术更优。

## 2.3 可扩展性（区域大小）

到达时间差（TDoA）技术，以三角形或者四边形为最小单位，同步方式可以做到主基站同步从基站，而且主基站也可以同步其他主基站，这样只需要注意基站在现场布局形状，就可以做到无限基站的扩展；而且增加的基站不会对其他现有的基站造成任何影响。

飞行时间测距（ToF），同样可以做到无限扩展区域，但是因为该方法测距过程的复杂性，因此需要现有基站的配合才可以使用。

结论：到达时间差（TDoA）技术更优。

## 2.4 物料成本

到达时间差（TDoA）技术，标签因为只需要发射，不需要接收，所以可以省掉接收和发送的无线切换开关以及周边的场效应管等器件；

飞行时间测距（ToF），标签发送和接收都需要，因此成本要高一些。

结论：到达时间差（TDoA）技术更优。

## 2.5 定位精度

到达时间差（TDoA）技术和飞行时间测距（ToF）均可以达到<30厘米的精度。

到达时间差（TDoA）技术需要基站之间进行同步，相对来说比较依赖温度的变化，如果基站使用的是普通晶振，定位精度会差一些；如果使用TCXO（温补型晶振），定位精度跟飞行时间测距（ToF）差别不大。

结论：到达时间差（TDoA）技术和飞行时间测距（ToF）持平。

## 2.6 系统健壮

到达时间差（TDoA）技术，定位一次需要基站发射一次同步包，标签发射一次定位包，因此只是存在两次的交互过程即可实现定位。

飞行时间测距（ToF），标签与单个基站需要3次数据交互，定位一次需要至少三个基站交互，总共9次收发过程，增加了测距的时间，容易受到干扰，造成测距和定位的成功率会下降。

结论：到达时间差（TDoA）技术更健壮。

# 三、结论

总体来说，到达时间差（TDoA）的方法会更优于飞行时间测距（ToF）。但是飞行时间测距（ToF）由于测距流程简单，所以会相对来说更容易开发一些，对功耗和标签容量没有要求的场景基本可以满足，例如实验室少量机器人的定位。