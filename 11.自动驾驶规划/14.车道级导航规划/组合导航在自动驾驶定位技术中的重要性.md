- [Pony Tech | Pony.ai 地图与定位系列文章：组合导航在自动驾驶定位技术中的重要性 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/512611484?utm_oi=35294141218816)

## 背景

随着自动驾驶时代的到来，高精度定位技术迎来了华丽绽放的机会。在自动驾驶相关的各种行业报告里，我们可以看到很多关于定位传感器的信息，比如摄像头、激光雷达、毫米波雷达、GNSS、IMU(惯性测量单元)等，那么这些传感器是如何发挥高精度定位能力的，业内同行很是关注。一些定位技术相关的术语比如视觉定位、激光里程计、视觉里程计、LiDAR点云匹配、视觉语义特征匹配、SLAM等已广为大家所知，但是有一个专业名词知名度并不高但却为自动驾驶的高精度定位立下了汗马功劳，那就是”组合导航”。

说起组合导航，字面意思就是组合一些信息源进行定位，然后用于导航，那么组合什么呢？在自动驾驶未兴起之前，即2010年以前，传统的组合导航技术的代表方案是组合GNSS、IMU、轮速计和导航电子地图数据，几乎包揽了汽车前装和后装的导航定位方案，由于当时车辆定位是给人用的，那么其定位精度在米级甚至十米级也能满足人的需求，定位的连续性、可靠性要求也不高，更不存在完好性的问题。因为那个时代GNSS还主要是单点定位，只能达到米级甚至十米级的水平；城市峡谷场景下GNSS单点定位几乎不可用，所以必须和惯导组合。然而随着自动驾驶时代的来临，传统的组合导航米级的定位精度显然无法给机器使用（因为米级的定位精度会让自动驾驶车冲出车道, 冲向人行道），那么是否意味着传统组合导航技术要退出历史舞台，进而采用视觉定位和LiDAR定位等更先进的技术呢？答案是否定的。**传统的组合导航技术仍然可以组合RTK(GNSS载波相位差分技术，可以实现厘米级定位精度)、IMU(高端MEMS IMU)、轮速计、 相机、LiDAR以及高精度地图等数据源一起实现厘米级定位精度。**这也是我们当前自动驾驶定位领域最为流行的一种方案。

对于L4级自动驾驶，当前高精度定位的实现还离不开高精度地图的辅助，那么高精度地图是如何建立的呢，这里不做详细的展开，但有一点需要说明，那就是**高精度地图里的车道线、斑马线、树木、交通牌、路灯、建筑物等一系列肉眼可以看到的静态物体的绝对位置和姿态都是由GNSS/IMU组合导航后处理的精度决定的**。也就是说组合导航技术不仅应用于实时定位还被用于离线建图，那么其重要性就加倍了。

## 原理

之所以早期要组合GNSS和IMU，那是因为各自有着彼此互补的优势，取长补短，在业内被誉为“黄金搭档”。 基于LiDAR和相机的定位技术比如LiDAR点云匹配、视觉语义特征匹配，它们可以提供绝对的位姿，作为绝对观测量可以用来抑制惯导误差的发散。而激光/视觉里程计提供的相对位姿，同样对惯导有着辅助作用，因为惯导推算误差会随着时间发散与周围环境特征无关，而激光/视觉里程计的推算误差是与周围可视的环境特征有关与时间无关，当车辆长时间处于低速缓慢行驶的场景里（比如高架下交通拥挤路段）激光/视觉里程计的误差会小于惯导的误差，当车辆行驶在空旷或周围环境特征较少时，激光/视觉里程计的误差会大于惯导的误差， 所以两者存在互补性。那么把大家组合在一起，将定位精度发挥到极致也是理所应当的。所以什么是组合导航呢？

**组合导航是通过实时最优估计算法对GNSS、IMU、轮速计、LiDAR点云匹配、视觉语义特征匹配、激光/视觉里程计等一系列定位信息源做数据融合，对不同种类的观测量实现高斯分布的融合(以贝叶斯估计理论为基础)，进而达到对待估参数最优估计的目的，从而得到车辆的高精度位置、速度和姿态，并且具备协方差输出能力**，接下来进行技术细节的展开。

先来一张跟定位相关的各种传感器在PonyAI自动驾驶车辆上的分布图：

![img](https://pic1.zhimg.com/80/v2-a91f7bc7021b17a1c7eeb36481ed1490_720w.jpg)

有了如上传感器，那么就需要设计实时优化算法(以卡尔曼滤波器为例)来实现各种定位信息源的融合，最终实现最优估计，具体的算法框架图如下：

![img](https://pic3.zhimg.com/80/v2-4c769b8fe5a8fa29c2e5c52acfa3557a_720w.jpg)

上图橙色部分即为组合导航技术要做的事情了，按照算法的先后顺序，具体可以分为以下几部分。

## 转台标定

由于自动驾驶对定位精度要求较高（横向位置误差小于20cm），低成本的IMU在出厂之后会存在各种误差（比如零偏、比例因子、交叉耦合等），需要进行精确标定才可以达到比较高的定位精度。因此PonyAI自主设计了低成本单轴转台用于对低成本IMU进行精确标定，具体方法仍然是以多位置标定法为主，其整个标定及验收过程只需要15分钟。其中，转台的角位置精度可以达到0.005 deg，陀螺仪的比例因子误差可以达到50ppm的标定精度。另外，每次的转台标定的结果都必须经过自动验收机制的评估，以便对于误差不达标的IMU可以提前筛选出来，保证装到自动驾驶汽车上的IMU都是合格的。以某款高精度IMU为例来验证低成本转台的标定重复性，下面给出多次IMU上电情况，转台标定的比例因子误差结果：

| 比例因子指标(单位:ppm) | 陀螺仪Z轴比例因子 | 加速度计X轴比例因子 | 加速度计Y轴比例因子 |
| ---------------------- | ----------------- | ------------------- | ------------------- |
| 标准差                 | 114               | 46                  | 59                  |
| 平均值                 | 416               | -423                | -722                |

从上面标定结果可以看到，低成本单轴转台对高精度IMU的比例因子标定误差可以做到100ppm， 这个误差比该款IMU的标称比例因子误差要小很多，所以低成本单轴转台完全可以胜任高精度MEMS IMU的标定工作。用该转台对其他低成本的IMU标定后发现，比例因子的补偿可以使姿态航向角精度提升34%-48%，如下：

![img](https://pic2.zhimg.com/80/v2-277483e7f2b31fe59351f473859596c9_720w.jpg)

## 初始对准

惯导的初始化包括对初始位置、速度和姿态的确定，而初始对准是指对初始姿态的计算，分为静态初始对准和动态初始对准。其中静态初始对准对于MEMS IMU来说无法通过感知地球自转角速度来确定航向（即陀螺罗盘）， 但可以依赖GNSS双天线来实现航向初始化。动态初始对准可以依赖GNSS位置变化和速度向量，同时也可以引入LiDAR点云匹配和视觉语义特征匹配来辅助初始对准。对于初始姿态的对准分为水平角调平和航向角计算，水平角调平主要依赖IMU的加速度计感知重力方向来实现，航向角可以依赖GNSS定位轨迹和速度方向进行计算得到。另外在实际使用中，也可以将车辆前次停车时的位置和姿态信息保留在车机内，下次开机可以直接加载使用，能更快速的实现初始对准，但这里面需要判断前次关机前和本次开机后车辆是没有被移动过的。

初始对准的好坏直接决定了组合导航起始阶段的定位精度，所以准确快速的初始对准在自动驾驶定位中是必备的一点。目前PonyAI在不依赖历史位置姿态以及不依赖GNSS双天线的情况下，可以实现小于30s的快速初始对准（不受车辆静止和低速影响）， 其位置误差（1sigma）< 10cm、水平角误差（横滚/俯仰， 1sigma）< 0.1deg、航向角误差（1sigma）< 0.2deg。

## 惯性导航

惯性导航是依靠IMU（陀螺仪和加速度计）原始数据，在初始对准的基础上，通过惯导机械编排算法实现位置、速度、姿态的不断递推。

![img](https://pic2.zhimg.com/80/v2-ce84b89734807f0df297672b0bdc8ca9_720w.jpg)

其推算的误差会随着时间而发散，最终的位置误差与加速度计零偏误差成时间的平方关系，与陀螺仪零偏误差成时间的立方关系，因此陀螺仪精度的好坏主导了惯性导航的推算精度。在不考虑初始位置、速度、姿态误差的情况下，并在多种简化后，IMU零偏误差与位置误差的关系如下：

![img](https://pic2.zhimg.com/80/v2-ee80e98ed3bbb121aec1dec8e5990141_720w.jpg)

其中Pos err是位置误差，bias a表示加速度计零偏误差，g表示重力，bias g表示陀螺仪的零偏误差，t2表示时间平方，t3表示时间三次方。

由于惯性导航的误差随时间累积，在实际使用过程中会选择采取一些外部观测量以及运动学约束来保持惯性导航的精度，比如用上轮速计和车辆非完整性约束(NHC)可以大幅度减缓纯惯性导航的误差发散。以成本在百元级的MEMS IMU为例，随便挑3辆自动驾驶车，通过对日常运营数据做GNSS outage仿真，可以评估IMU+轮速的相对推算精度，其中GNSS outage是通过人为断掉GNSS绝对观测量的一种评估方法，这里一共仿真了400个outage，每次outage的时间长度60s，提取每次outage中位置漂移的最大值，统计这400次outage位置漂移最大值的RMS作为评估指标，其IMU+轮速计+NHC的推算精度(RMS) 统计如下 (在自动驾驶定位实际应用中更为关注横向位置精度, 且纵向和垂向精度与横向相当)：

| GNSS Outage 次数: 400 | 位置误差 RMS即1sigma (单位: 米) |
| --------------------- | ------------------------------- |
| 横向                  |                                 |
| 10s                   | 0.11                            |
| 30s                   | 0.21                            |
| 60s                   | 0.35                            |
| 行驶500m              | 0.33                            |

从上面的统计结果可以看出，以横向位置推算误差RMS为例即1sigma，百元级MEMS IMU +轮速计+NHC可以做到60s在0.35米，换算成与行驶距离的百分比大概是0.066%，即车辆行驶1000米，只靠IMU、轮速计、NHC的位置推算误差的1sigma为0.66米。

## 车辆运动学约束

在纯惯性导航递推过程中，惯导递推的误差会随着时间增加而变大，在实际使用中，常常会用非完整性约束、零速修正、零积分航向速率等车辆的动态和静态特性对纯惯性导航误差进行抑制和修正。

![img](https://pic3.zhimg.com/80/v2-33797f9c36dea26b5f0ab5243359965a_720w.jpg)

非完整性约束(NHC, Non-holonomic constraints)是假设车辆在道路行驶不会存在横向漂移和垂向跳跃，即在车辆坐标系（x代表前、y代表左、z代表上）进行了如下假设：

![img](https://pic4.zhimg.com/80/v2-a7d79bebb6ca7cf2fc8ba360f34c58df_720w.jpg)

零速修正(ZUPT, zero velocity update)是当判断出车辆静止状态时，会假设车辆三维速度都为0，零速作为观测量输入给卡尔曼滤波可以很好的抑制纯惯性导航位置和速度误差的发散。

零积分航向速率(ZIHR, zero integrated heading rate)是在车辆判断出静止状态时，假设车辆的航向保持不变，即采用一个航向变化速率为0的虚拟观测量输入给卡尔曼滤波，可以很好的抑制纯惯性导航的航向角误差的发散。

如果能拿到四轮车速以及前两轮的转向角信息，可以采用四轮速度辅助约束能明显提升转弯时纯惯性导航的推算精度。由于采用了NHC和轮速计这些来自车辆载体的更新，IMU和轮速计的杆臂补偿需要考虑，IMU的安装角以及轮速的比例因子误差都需要增广到卡尔曼滤波状态里进行在线估计和补偿，可以明显提升定位精度。

## 故障检测与隔离

在组合导航卡尔曼滤波算法中，由于输入给卡尔曼滤波的观测量众多，每一个观测量的好坏对卡尔曼滤波的估计影响都很大，因此在观测量输入给卡尔曼滤波器之前，需要有一个故障检测与隔离机制来尽早发现不可用的观测量，避免无效的观测量对滤波器产生破坏作用。

以GNSS为例，会用定位类型（单点、伪距差分、浮点解、固定解）、 DOP值、可用卫星数、信噪比、差分龄期、标准差、信号干扰位、信号中断时间等指标作为故障检测与隔离的重要依据。

以点云匹配为例，会用地图潜在变化区域、纵向特征不明显、点云视线受阻等信息来对点云匹配的观测量进行有效的检测和隔离。

该模块更多的是从观测量源头端直接进行检测和隔离，作为滤出观测量的第一道屏障为下游的质量控制和卡尔曼滤波抵挡了很多错误甚至无效的观测量，减轻下游对观测量品质精准识别的压力。

## 质量控制

质量控制模块是组合导航卡尔曼滤波算法的核心之一，因为一个观测量的好坏对于状态量的最优估计至关重要，需要一个精细的质量控制算法进行识别。常用的算法为卡方检验，卡方值越大越能代表当前观测量不够好。这里面比较难的是如何确定卡方值的阈值，该问题也是决定卡方检验准确识别观测量好坏的关键。在实际使用过程中，可以采用自学习的方式，对于卡方阈值进行一个在线训练和学习，首先要知道好的状态是什么样，才能去判断不好的状态是啥样。以下三种场景遇到的观测量出错的问题都可以通过卡方检验算法进行解决。

场景一：自动驾驶车辆被大车包围，造成激光雷达可用点云较少，点云匹配可能出错

![img](https://pic1.zhimg.com/80/v2-f59d093b6da84e37566015ad7ba2d0d8_720w.jpg)

场景二：自动驾驶车辆行驶至道路施工路段，造成环境变化，点云匹配可能出错且RTK不可用

![img](https://pic4.zhimg.com/80/v2-3cefbfeae9b2ba49f5450fe03be358a7_720w.jpg)

场景三：车道线出现重刷，可能会造成视觉语义特征匹配出错

![img](https://pic3.zhimg.com/80/v2-58f6ec795493049760562e30ac375092_720w.jpg)

经过卡方检验之后，需要对观测量进行逐级判定，即是剔除、还是降权、还是升权。经过精确的分级之后，才能充分发挥观测量的价值，保证了错误的观测量不会进入卡尔曼滤波器，价值不够强的可以削弱其权重，对于很有价值的观测量可以增加其权重。经过这三类不同等级观测量的使用，可以很好的保证卡尔曼滤波器的最优估计。

对于跳变的观测量误差，卡方检验算法可以很好的识别和分类，但是对于缓慢偏开的观测量粗差，卡方检验需要结合其他新方法进行解决。除了卡方检验之外，还会采用多传感器融合的优势，利用不同观测量之间的相互校验来识别观测量的品质。常用的方法可以参考投票机制，即以多数观测量保持一致为原则，剔除或降权不一致的观测量，该方法能很好的识别缓慢漂的观测量粗差。如RTK在某些场景下会存在从5厘米到50厘米的缓慢漂移，该问题可以通过多观测量的相互校验来解决。

## 卡尔曼滤波

卡尔曼滤波算法的五个基础方程，这里不做描述了。值得强调的是，卡尔曼滤波算法仍然是目前自动驾驶定位领域在解决实时最优估计问题方面性价比很高的一种方法。

一般来说，导航定位领域会采用误差状态卡尔曼滤波(ESKF, error state Kalman filter)，它可以被认为是一种扩展卡尔曼滤波(EKF, extended Kalman filter)。误差状态卡尔曼滤波算法是以待估参数误差作为状态量，在小误差假设下对误差模型和观测模型进行线性化，其优化指标是使待估状态方差达到最小。由于GNSS、IMU、轮速计以及其他绝对或相对观测量大都与待估状态属于线性关系，因此ESKF仍然是目前组合导航主流的估计算法，其他的诸如非线性最小二乘、粒子滤波、因子图优化等非线性优化算法更适合于视觉、LiDAR的建图和定位方案，对于实时定位来说，组合导航卡尔曼滤波目前是各类定位源融合的首选算法（因为其计算效率高, 量产可靠性好，也具备较好的快速收敛能力），它承担了为下游输出定位定姿信息的任务，在未来一段时期内，以ESKF为核心融合各类观测量来实现状态最优估计将是自动驾驶领域公开道路定位技术的主流算法框架。组合导航将背负自动驾驶定位准确性和可靠性的艰巨任务，要必须识别好，利用好各种观测量。

当前组合导航的卡尔曼滤波以松耦合算法为主，状态量有位置误差、速度误差、姿态误差、陀螺仪零偏、加速度计零偏、轮速计比例因子误差、IMU安装角，共计19维。观测量分别有GNSS位置/速度观测、LiDAR点云匹配的位置/姿态观测、视觉语义特征匹配的位置/姿态观测、轮速计的速度观测以及其他一些车辆运动学约束观测量。紧耦合可以作为后台备份冗余，当GNSS卫星数少的时候，可以为松耦合提供绝对位置观测量，当GNSS卫星数多的时候，紧耦合和松耦合的定位性能是相当的。

## 完好性检测

虽然组合导航定位系统的可靠性能够做到接近100%，但是难以完全达到100%。这就要求定位系统在没有办法提供准确的输出时，及时警告下游采取措施，避免发生由于定位不准而引起的事故。所以，自动驾驶的定位系统应保证0%的虚警率与漏警率。在当前自动驾驶安全第一的前提下，对定位系统出现潜在风险时的警告和接管的召回率要做到100%，在此基础上尽量提高准确率。

这里我们并没有采用经典的完好性算法去计算完好性风险和保护门限，而是采用多观测量的优势以及卡尔曼滤波的状态协方差矩阵来综合识别定位的风险, 并及时的通知到下游。

![img](https://pic1.zhimg.com/80/v2-334c13fb97c3976137b43e2ec51688bc_720w.jpg)

## 效果展示

### 城区定位效果

以北京亦庄城区自动驾驶的一条路线为例 （包含了城市高楼场景和地下通道等GNSS信号不可用的场景以及道路施工造成的LiDAR点云匹配或视觉语义特征匹配不可用的场景），组合导航融合各类信息源得到的全程最终定位精度如下：

![img](https://pic3.zhimg.com/80/v2-30fc9f45a1af68384b2e1b8e8991e4ee_720w.jpg)

可以看出横向和纵向定位精度能做到10cm以内，垂向定位精度能做到15cm以内，充分说明了当前自动驾驶定位可以做到水平方向厘米级的高精度，更能保证自动驾驶的安全性。

### 隧道定位效果

在GNSS不可用的场景下如隧道，更多是依赖IMU、轮速计、LiDAR点云匹配、视觉语义特征匹配来保证全程相对定位误差处于安全的水平，这样可以使车辆在隧道内一直处于自动驾驶模式，始终在车道内没有偏离车道的风险。以RoboTruck为例，目前PonyAI已经实现过山隧道4.2km，全程相对定位误差（即基于LiDAR点云和视觉语义特征与高精度地图匹配的误差）小于0.1米。

![img](https://pic1.zhimg.com/80/v2-5a515a36077827e38caea3b71c061484_720w.jpg)

## 展望

从当前L4级自动驾驶城区运营情况来看，由于定位不准产生的接管已经非常少了，那么组合导航技术在自动驾驶应用中接下来如何发展呢，我们将通过以下几点进行展望。

- **考虑RTK不可用的风险**

当前L4级自动驾驶定位采用了GNSS的RTK技术，从而实现高精度厘米级定位，这就会引入一个风险，即RTK需要网络通信服务才可以实现差分数据的播发。在真实场景中，网络服务的稳定性问题以及潜在的信号欺骗干扰都会造成RTK长时间不可用，因此长时间（小时级）不依赖RTK，充分挖掘惯导+轮速的递推精度和基于LiDAR和视觉的特征匹配等一系列高精度相对定位技术将会是L4级自动驾驶量产方案的发展趋势。

- **满足低成本, 高精度, 车规级和功能安全**

组合导航定位硬件里面采用了GNSS和IMU，两者在未来L4级自动驾驶量产中需要符合车规级 AEC-Q100和功能安全 ISO26262，同时满足低成本。IMU作为唯一一个不依赖外界任何信号可以实现自主定位的器件，其定位精度的好坏直接决定了自动驾驶定位安全的底线。因此，为了面向未来L4级自动驾驶量产，IMU需要满足低成本和高精度，其中低成本主要体现在单个IMU的成本应该在百元级，而高精度具体体现在以下关键指标：

1. **陀螺仪**

2. 1. 零偏稳定性(10s平滑)需要做到小于 5 deg/h
   2. 零偏不稳定性(Allan方差谷底)需要做到小于 1.5 deg/h
   3. 全温零偏需要做到小于0.15 deg/s

3. **加速度计**

4. 1. 零偏稳定性(10s平滑)需要做到小于 0.1 mg
   2. 零偏不稳定性(Allan方差谷底)需要做到小于 0.05mg
   3. 全温零偏需要做到小于 5 mg

- **组合导航完好性保障**

在未来大规模L4级自动驾驶商业化落地之后，成千上万辆自动驾驶车7*24小时行驶在大街小巷，安全永远是第一位的。涉及到定位技术，组合导航承担着对下游感知和规划控制输入精准位姿的任务，其结果的好坏需要准确可靠的衡量，那么完好性检测将会是不可或缺，极其重要的一个发展方向，是一个刚需。

## 结语

自动驾驶的发展趋势浩浩荡荡不可阻挡，定位技术多源融合势在必行，在多年以后回顾今日，此番百舸争流千帆竞, 乘风破浪正当时的景象必定会载入史册。组合导航也需要与时俱进、顺势而行、创新发展才能历久弥新，不坠青云之志。