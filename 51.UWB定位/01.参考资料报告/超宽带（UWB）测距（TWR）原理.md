- [超宽带（UWB）测距（TWR）原理 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/61538564)

## UWB超宽带概念

UWB是一种无线载波通信技术，利用纳秒级的非正弦波窄脉冲传输数据，工作频段在3.25GHZ~6.75GHZ，频宽典型值为500MHZ或者1GHZ，所以可以获取亚纳米的精确时间（1ns约等于30cm）。

UWB信号的时域波形如图1-1所示。不同于传统的无线射频信号有固定频率的载波（如蓝牙2.4G），UWB在不发送数据时是完全静态的，要发送数据时才发送宽度很窄（如1ns）的脉冲信号。该窄脉冲在频域上很宽，所以叫超宽带。因为UWB时域信号脉冲较窄，所以在时间、空间上有较大分辨力，比较容易抵抗室内信号传输常见的多径效应（信号因为反射造成的多路径传播）的影响，因此测距和定位精度较高。



![img](https://pic4.zhimg.com/80/v2-8d5acd02eab58218e76e19e63cb0ab4b_720w.jpg)



图 1‑1 超宽带时域和幅关系





![img](https://pic4.zhimg.com/80/v2-27f2561fa89a3dc8eeaca7b3719b207f_720w.jpg)



图 1‑2 超宽带频域和功率关系



## UWB测距原理

UWB测距主要采用双向测距(Two-way Ranging)方法，以下所有的方法都包括两个节点：设备A和设备B，默认设备A是测距的发起者，设备B是响应者；双向测距主要分为以下两种方法：

1. 单边双向测距(Single-sided Two-way Ranging)
2. 双边双向测距(Double-sided Two-way Ranging)
3. 使用4消息方式（4 messages）
4. 使用3消息方式（3 messages）

## 单边双向测距(Single-sided Two-way Ranging)

单边双向测距(Single-sided Two-way Ranging)，单侧双向测距（SS-TWR）是对单个往返消息时间上的简单测量，设备A主动发送数据到设备B，设备B返回数据响应设备A。



![img](https://pic2.zhimg.com/80/v2-4af12029a988ad38de11584d7d26e965_720w.jpg)



图 2‑2 单边双向测距

测距流程：设备A（Device A）主动发送（TX）数据，同时记录发送时间戳，设备B（Device B）接收到之后记录接收时间戳；延时Treply之后，设备B发送数据，同时记录发送时间戳，设备A接收数据，同时记录接收时间戳。

所以可以拿到两个时间差数据，设备A的时间差Tround和设备B的时间差Treply，最终得到无线信号的飞行时间Tprop如下：



![img](https://pic4.zhimg.com/80/v2-dbb2c2b27be1f0e6c610fb12862fa613_720w.jpg)



两个差值时间都是基于本地的时钟计算得到的，本地时钟误差可以抵消，但是不同设备之间会存在微小的时钟偏移，假设设备A和B的时钟偏移分别为eA和eB，因此得到的飞行时间会随着Treply的增加而增加，测距误差的方程如下：



![img](https://pic1.zhimg.com/80/v2-aa0772e5e472a327834b5c53674ade5c_720w.jpg)



Treply越小，测距越准确。另外Treply不仅仅是设备B接收到发送的时间，也包括装载数据和发送数据耗费的时间（UWB除了支持定位之外，也可以传输数据，标准可以装载128字节，扩展模式可以装载1024字节数据）。典型的误差关系如下：（1ns约等于30cm距离误差）



![img](https://pic4.zhimg.com/80/v2-6855787a7133e4104e5d7e0806d87fd7_720w.jpg)



可以看出，随着Treply和时钟偏移的增加，会增加飞行时间的误差，从而使得测距不准确。 因此单边双向测距（SS-TWR）并不常用，但对于特定的应用，如果对于精度要求不是很高，但是需要更短的测距时间可以采用。



## 双边双向测距（Double-sided Two-way Ranging）

双边双向测距（Double-sided Two-way Ranging）是单边双向测距的一种扩展测距方法，记录了两个往返的时间戳，最后得到飞行时间，虽然增加了响应的时间，但会降低测距误差。双边双向测距根据发送消息个数不同，分为两种方法：

- 4消息方式（4 messages）
- 3消息方式（3 messages）

### 2.2.1 双边双向测距4消息方式

分为两次测距，设备A主动发起第一次测距消息，设备B响应，得到4个时间戳；然后过了一段时间，设备B主动发起测距，设备A响应，同样得到4个不同的时间戳。最终可以得到如下四个时间差：

- Tround1
- Treply1
- Tround2
- Treply2



![img](https://pic3.zhimg.com/80/v2-c1038aa39f21da33c32f4ed7fa14860e_720w.jpg)



图 2‑2 双边双向测距4消息方式

### 2.2.2 双边双向测距3消息方式

相比较于4消息方式，省掉了第二次测距的发起动作，当设备A收到数据之后，立刻返回数据，最终也可以得到如下四个时间差：

- Tround1
- Treply1
- Tround2
- Treply2





![img](https://pic2.zhimg.com/80/v2-7950a5320d54cb2a53d3e6447cbef29d_720w.jpg)



图 2‑3 双边双向测距3消息方式

### 2.2.3 双边双向测距飞行时间计算方法

飞行时间计算方法，无论是4消息方式或者3消息方式，都可以使用如下公式计算：



![img](https://pic2.zhimg.com/80/v2-e243ccaca260778c323de84e702a6bd9_720w.jpg)



### **2.2.4 双边双向测距飞行时间误差分析**

以上测距的机制都是非对称的测距方法，因为他们对于响应时间不要求是相同的。使用2.2.1和2.2.2的方法测距，即便使用20ppm的晶体，时钟误差也是在ps级别的。误差公式如下：



![img](https://pic3.zhimg.com/80/v2-cf5f18036a57ae4b30fb9203987dfeee_720w.jpg)



设备A以需要的频率Ka运行，设备B以需要的频率Kb运行，Ka和Kb都是接近于数值1的。

为了搞清楚这个错误值得大小，如果设备A和B以比较差的晶振（20ppm误差）运行，例如设备A慢20ppm，设备B快20ppm，或者放过来，这样将会导致总的误差在40ppm，这样Ka和Kb可能是0.99998或者1.00002，

即使UWB的工作距离范围较大，例如100m，无线信号空中飞行时间大概333ns，因为误差为：20 x 10e-6 x 333 x 10e-9 = 6.7 x 10e-12 = 6.7ps，换算为距离之后也仅仅2.2mm。

注意：响应时间是不需要相等的，也及时Treply1不一定要等于Treply2，这样对于MCU系统的处理带来了很多便利。

主要的误差来源一定是接收数据的时间戳是否正确。而不是晶体的ppm值。

### **2.2.5 双边双向测距（响应时间对称）**

比较特殊的例子，双边双向测距方法响应时间对称，也就是Treply1和Treply2相等，飞行时间计算方法如下：



![img](https://pic3.zhimg.com/80/v2-f4c6216a660e850f7c26ac92fb35c012_720w.jpg)



这种方法只是需要一些时间戳做加减法，然后除以4就可以得到飞行时间，但是可能需要更多的时间。另外这种方法的难点在于，怎么保证Treply1和Treply2是相等的。