一种基于不同协议的地图格式之间的转换方法

## 1 摘要 

本发明公开基于不同协议的地图格式之间 的转换方法。提取OpenDrive协议地图格式中道 路ID，对不同道路元素进行路点坐标值转换；将 OpenDrive协议地图格式中每一条道路ID转换为 Apollo格式中两个独立道路并赋予新道路id，将 路点坐标集存在对应道路id下；将OpenDrive协 议格式地图的UTM坐标转到经纬度坐标系下，将 经纬度坐标系下路点坐标集添到对应道路id下； 根据车道中心线和车道边界线上路点坐标值将 相邻道路拼接；将OpenDrive协议格式地图文件 信息及路点坐标值按Apollo协议格式编写，完成 道路间拓扑关系转换。本发明在两种不同协议地 图之间搭建桥梁，提高地图应用和转换灵活性。

1 .一种基于不同协议的地图格式之间的转换方法，其特征在于，是将OpenDrive协议格 式地图转换为Apollo协议格式地图，包括步骤： 

S1 .提取OpenDrive协议地图格式中的道路ID，对不同的道路元素进行路点坐标值转 换； 

S2 .将OpenDrive协议地图格式中的每一条道路ID转换为Apollo格式中两个独立的道 路并赋予新的道路id，将对应的路点坐标集数据存储在对应道路id下，完成不同地图格式 间基本道路元素的转换； 

S3 .将OpenDrive协议格式地图采用的UTM坐标转换到经纬度坐标系下，将经纬度坐标 系下的路点坐标集添加到对应的道路id下； 

S4 .根据车道中心线和车道边界线上路点坐标值将相邻道路进行拼接； 

S5 .将OpenDrive协议格式的地图文件信息以及路点坐标值按Apollo协议格式重新编 写，完成道路间拓扑关系转换，从而完成两种格式地图转换。 

2 .根据权利要求1所述基于不同协议的地图格式之间的转换方法，其特征在于，所述不 同的道路元素包括直线道路、圆弧道路以及螺旋道路。

3 .根据权利要求2所述基于不同协议的地图格式之间的转换方法，其特征在于，所述直 线道路的路点坐标值转换的步骤如下： 查找OpenDrive协议格式中直线道路的起始点、车道宽度、车道数量、道路中心线、车道 中心线、道路方向角信息；

将道路中心线左右两侧车道分别进行路点坐标值转换，然后对道 路中心线进行路点坐标值转换；

在道路中心线的路点转换完成后，结合各车道边界线和车 道中心线距离道路中心线的宽度信息，按照从中间向两边映射的方法依次对车道边界线和 车道中心线上的路点坐标值进行转换。 

4 .根据权利要求3所述基于不同协议的地图格式之间的转换方法，其特征在于，所述对 道路中心线进行路点坐标值转换时，根据道路起始点信息、指定路点间距、道路中心线方向 角参数，判断给定的路点间距是否大于本道路长度，若大于则需缩短路点距离；

反之，按转 换公式将OpenDrive中给定的道路中心线相关参数转换为道路路点坐标，实现用路点集描 述道路中心线。 

5 .根据权利要求2所述基于不同协议的地图格式之间的转换方法，其特征在于，所述圆 弧道路的路点坐标值转换的步骤包括圆弧道路中心线的路点坐标值转换以及圆弧道路边 界线的路点坐标值的转换； 

所述圆弧道路中心线进行路点坐标值转换时，根据圆弧道路起始点信息、指定路点间 距、圆弧道路中心线方向角参数，判断给定的路点间距是否大于本道路长度，若大于则需缩 短路点距离；

反之，将OpenDrive中给定的圆弧道路中心线相关参数转换为道路路点坐标， 实现用路点集描述道圆弧路中心线； 

所述圆弧道路边界线的路点坐标值的转换时，首先根据圆弧道路中心线参数计算出圆 弧道路元素车道边界线和车道中心线相关几何参数，然后按照上述圆弧道路中心线路点坐 标值转换的方法，进行各个车道路点坐标值的计算。

 6 .根据权利要求2所述基于不同协议的地图格式之间的转换方法，其特征在于，所述螺 旋线道路元路点坐标值的转换，是先建立螺旋线局部坐标系，然后根据坐标系旋转矩阵公 式进行初次的坐标关系变换，将螺旋线局部坐标系变换到与UTM坐标系一致；

然后根据计算出螺旋线道路中心线上路点坐标集在UTM坐标系下的绝对坐标值，按照从中间向两端映射 的方法计算对应的车道边界线和车道中心线上的路点坐标集。 

7 .根据权利要求2所述基于不同协议的地图格式之间的转换方法，其特征在于，所述根 据坐标系旋转矩阵公式进行初次的坐标关系变换，将螺旋线局部坐标系变换到与UTM坐标 系一致的步骤如下： 

基于螺旋线道路起始点坐标、道路长度、起始点方向角、车道信息、起始曲率、终止曲率 参数，根据螺旋线局部坐标计算公式对局部坐标系下的螺旋线的路点坐标值进行计算；

将 计算出的螺旋线道路描述坐标集通过坐标系旋转矩阵转换到UTM坐标系下获得其相对UTM 坐标值，然后结合螺旋线给定的起始点坐标值算出其路点集在UTM坐标系下的绝对坐标值。 

8 .根据权利要求1所述基于不同协议的地图格式之间的转换方法，其特征在于，所述的 根据车道中心线和车道边界线上路点坐标值将相邻道路进行拼接的步骤是，判断相邻道路 车道中心线和车道边界线上路点坐标值是否存在重合点，即各个路点在UTM坐标系下的坐 标值是否相等，若存在重合点，需将重合路点坐标删除，从而实现相邻道路间的无缝连接。

## 2 背景技术 

[0002] 自动驾驶技术的发展离不开高精地图，但在自动驾驶领域中高精地图资源相对稀 缺，使得高精地图的制作在自动驾驶领域的应用中尤为重要。高精地图可以帮助汽车预先 记录复杂路面信息，如道路长度，道路方向，形状，曲率等信息，结合自动驾驶领域中的路径 规划，行为决策等给出合理的驾驶行为。 

[0003] 由于现实中进行高精地图的实地采集耗时、制作效率较低和场地的局限性，一定 程度上限制了自动驾驶行业的发展。目前存在比较快的建图方法一般是通过制图软件快速 搭建出虚拟场景道路，并以OpenDrive协议记录其道路信息。 

[0004] 但**由于以OpenDrive协议记录的道路信息不能直接应用于自动驾驶车辆，使的地 图的使用具有一定的局限性**。

实际在自动驾驶领域中应用的地图格式是通过实地采集获得 地图数据，需要工作人员或者车辆在实际场地进行地图数据的采集，然后对数据进行后处 理，以Apollo协议格式记录相关道路信息，形成以Apollo协议格式进行记录的地图文件，并 应用于自动驾驶车辆的测试和运行中。因此要实现高精地图在自动驾驶领域的大范围应 用，需先实现Apollo协议地图格式的快速生成。 

[0005] 目前存在部分地图制作软件可实现简单的Apollo格式地图制作，但无法实现对复 杂道路地图的建立，复杂地图的建立仍需依靠实地采集地图数据，采用手动补充方式对于 局部缺少的地图结构进行完善，然后生成完整的Apollo格式地图。因而，使得现有的Apollo 协议格式地图采集方法耗时较长，建图效率不高，可建立的地图场景有限，地图结构简单 等，一定程度上限制了地图在自动驾驶领域的使用。

## 3 发明内容 

[0006] 本发明的目的是针对上述的技术问题，而提供一种基于不同协议的地图格式之间 的转换方法，将基于OpenDrive协议的地图格式转换为基于Apollo协议的地图格式，即将制 图软件生成的OpenDrive格式地图通过转换方法快速转换成Apollo格式地图供自动驾驶车 辆用于测试或运行，从而解决了当前自动驾驶领域中场景地图搭建效率低和采图场地局限 的问题。 

[0007] 为实现本发明的目的所采用的技术方案是： 

[0008] 一种基于不同协议的地图格式之间的转换方法，是将OpenDrive协议格式地图转 换为Apollo协议格式地图，包括步骤： 

[0009] S1 .提取OpenDrive协议地图格式中的道路ID，对不同的道路元素进行路点坐标值 转换； 

[0010] S2 .将OpenDrive协议地图格式中的每一条道路ID转换为Apollo格式中两个独立的道路并赋予新的道路id，将对应的路点坐标集数据存储在对应道路id下，完成不同地图 格式间基本道路元素的转换； 

[0011] S3 .将OpenDrive协议格式地图采用的UTM坐标转换到经纬度坐标系下，将经纬度 坐标系下的路点坐标集添加到对应的道路id下； 

[0012] S4 .根据车道中心线和车道边界线上路点坐标值将相邻道路进行拼接； 

[0013] S5 .将OpenDrive协议格式的地图文件信息以及路点坐标值按Apollo协议格式重 新编写，完成道路间拓扑关系转换，从而完成两种格式地图转换。 

[0014] 其中，所述不同的道路元素包括直线道路、圆弧道路以及螺旋道路。 

[0015] 优选的，所述直线道路的路点坐标值转换的步骤如下： 

[0016] 查找OpenDrive协议格式中直线道路的起始点、车道宽度、车道数量、道路中心线、 车道中心线、道路方向角信息；将道路中心线左右两侧车道分别进行路点坐标值转换，然后 对道路中心线进行路点坐标值转换；

在道路中心线的路点转换完成后，结合各车道边界线 和车道中心线距离道路中心线的宽度信息，按照从中间向两边映射的方法依次对车道边界 线和车道中心线上的路点坐标值进行转换。 

[0017] 优选的，所述对道路中心线进行路点坐标值转换时，根据道路起始点信息、指定路 点间距、道路中心线方向角参数，判断给定的路点间距是否大于本道路长度，若大于则需缩 短路点距离；

反之，按转换公式将OpenDrive中给定的道路中心线相关参数转换为道路路点 坐标，实现用路点集描述道路中心线。 

[0018] 优选的，所述圆弧道路的路点坐标值转换的步骤包括圆弧道路中心线的路点坐标 值转换以及圆弧道路边界线的路点坐标值的转换； 

[0019] 所述圆弧道路中心线进行路点坐标值转换时，根据圆弧道路起始点信息、指定路 点间距、圆弧道路中心线方向角参数，判断给定的路点间距是否大于本道路长度，若大于则 需缩短路点距离；

反之，将OpenDrive中给定的圆弧道路中心线相关参数转换为道路路点坐 标，实现用路点集描述道圆弧路中心线； 

[0020] 所述圆弧道路边界线的路点坐标值的转换时，首先根据圆弧道路中心线参数计算 出圆弧道路元素车道边界线和车道中心线相关几何参数，然后按照上述圆弧道路中心线路 点坐标值转换的方法，进行各个车道路点坐标值的计算。 

[0021] 优选的，所述螺旋线道路元路点坐标值的转换，是先建立螺旋线局部坐标系，然后 根据坐标系旋转矩阵公式进行初次的坐标关系变换，将螺旋线局部坐标系变换到与UTM坐 标系一致；

然后根据计算出螺旋线道路中心线上路点坐标集在UTM坐标系下的绝对坐标值， 按照从中间向两端映射的方法计算对应的车道边界线和车道中心线上的路点坐标集。 

[0022] 优选的，所述根据坐标系旋转矩阵公式进行初次的坐标关系变换，将螺旋线局部 坐标系变换到与UTM坐标系一致的步骤如下： 

[0023] 基于螺旋线道路起始点坐标、道路长度、起始点方向角、车道信息、起始曲率、终止 曲率参数，根据螺旋线局部坐标计算公式对局部坐标系下的螺旋线的路点坐标值进行计 算；

将计算出的螺旋线道路描述坐标集通过坐标系旋转矩阵转换到UTM坐标系下获得其相 对UTM坐标值，然后结合螺旋线给定的起始点坐标值算出其路点集在UTM坐标系下的绝对坐 标值。 

[0024] 优选的，所述的根据车道中心线和车道边界线上路点坐标值将相邻道路进行拼接的步骤是，判断相邻道路车道中心线和车道边界线上路点坐标值是否存在重合点，即各个 路点在UTM坐标系下的坐标值是否相等，若存在重合点，需将重合路点坐标删除，从而实现 相邻道路间的无缝连接。 

[0025] 本发明提供的针对OpenDrive协议格式地图到Apollo协议格式地图的转换方法， 对现有大量OpenDrive协议格式地图在自动驾驶领域中提供了很大的应用空间，解决了现 场采集地图效率低，场景地图有限等问题，提高了高精地图应用的灵活性，以及自动驾驶车 辆在不同场景地图下的测试效率；

同时节省了大量的人力采图成本和时间成本，在两种不 同协议地图之间搭建了桥梁，提高了地图应用和转换的灵活性。

## 4 附图说明 

[0026] 图1是本发明的基于不同协议的地图格式之间的转换方法的流程示意图； 

[0027] 图2是道路ID转换的示意图。具体实施方式 

[0028] 以下结合附图和具体实施例对本发明作进一步详细说明。应当理解，此处所描述 的具体实施例仅仅用以解释本发明，并不用于限定本发明。 

[0029] 本发明是针对OpenDrive协议格式地图和Apollo协议格式地图之间的转换方法， 包括道路基本组成几何元素的转换、车道边界线的转换、车道中心线的转换、坐标转换、道 路id转换以及其他道路元素和协议格式间的转换。 

[0030] 如图1所示，本发明基于不同协议的地图格式之间的转换方法，包括步骤： 

[0031] 第一步：道路基本组合元素转换。根据已知OpenDrive协议地图格式，将其中的道 路id提取出来，对该道路的基本组成元素进行判断，包括直线、圆弧和螺旋线几何元素路点 坐标集的计算。 

[0032] 1 .直线道路元素路点转换。 

[0033] 查找已知地图格式中直线道路的起始点、车道宽度(width)、车道数量、道路中心 线、车道中心线、道路方向角等信息。将道路中心线左右两侧车道分别进行转换。对道路中 心线转换时，根据道路起始点信息、指定路点间距、道路中心线方向角等参数，判断给定的 路点间距是否大于本道路(当前要转换的道路)长度，如果大于，则需缩短路点距离；

反之， 按照一定的转换公式将OpenDrive中给定的道路中心线相关参数转换为道路路点坐标，用 路点集来描述道路中心线。道路中心线上的路点转换完成后，结合各车道边界线和车道中 心线距离道路中心线的宽度信息，按照从中间向两边映射的方法依次对车道边界线和车道 中心线上的路点坐标值进行转换。 

[0034] 需要说明的是，无人驾驶用的是高精度地图，地图中是存在车辆的行驶路线的，行 驶路线是由一系列的点组成的，点与点之间的距离一般是10厘米，这些点，就是路点，10厘 米就是路点间距。 

[0035] 需要说明的是，Apollo地图也称无人驾驶高精地图，道路中有车辆要行走的路线， 路线是点集描述的，点集由大量点组成，点的描述需要坐标，坐标是UTM坐标，也称为大地坐 标系，最后会转换成经纬度坐标描述。因此上述的道路路点坐标是经纬度坐标。 

[0036] 其中，OpenDrive中对于道路是通过公式描述的，将道路描述成直线，圆弧和螺旋线，转换过程就是把他们分别各自计算成路点集合，以Apollo地图格式对其进行存储。 

[0037] 2 .圆弧道路元素路点转换。 

[0038] OpenDrive格式中基本道路元素圆弧的参数，包括圆弧长度、曲率、起始点、车道边 界和车道中心线距离道路中心线的距离(可转换为车道宽度信息)、圆弧道路中心线起始点 坐标等参数。该道路中心线的路点转换方法与直线思路相同，即给定路点距离，结合道路长 度信息依据转换公式计算出对应路点坐标值，用路点集描述圆弧道路。 

[0039] 圆弧道路的车道边界线和车道中心线的求解思路与直线不同，即圆弧道路车道信 息路点坐标的求解应采用独立的求解方法。首先根据道路中心线参数，计算出圆弧形车道 边界线和车道中心线相关几何参数，然后按照与道路中心线路点集同样的求解方法依次进 行各个车道路点坐标的计算。 

[0040] 3 .螺旋道路元素路点转换。 

[0041] 螺旋线道路元素几何形状比较特殊，在进行路点坐标计算前，需建立螺旋线局部 坐标系，然后根据坐标系旋转矩阵公式进行初次的坐标关系变换，将螺旋线的局部坐标系 变换到与UTM坐标系一致。

![image-20220507142136675](https://www.lovebetterworld.com:8443/uploads/2022/05/07/62760fce19b5b.png)

[0043] 基于螺旋线道路起始点坐标、道路长度、起始点方向角、车道信息、起始曲率、终止 曲率等参数，根据螺旋线局部坐标计算公式对局部坐标系下的螺旋线的路点坐标值进行计 算。将计算出的螺旋线道路描述坐标集通过坐标系旋转矩阵转换到UTM坐标系下获得其相 对UTM坐标值，然后结合螺旋线给定的起始点坐标值算出其路点集在UTM坐标系下的绝对坐 标值。根据计算出螺旋线道路中心线上路点坐标集在UTM坐标系下的绝对坐标值，按照从中 间向两端映射的方法计算对应的车道边界线和车道中心线上的路点坐标集。 

[0044] 其中，螺旋线的曲率变化率与道路长度成比例关系，其曲率的变化率对计算路点 在局部坐标系下的坐标值尤为重要，可确保结果的准确性。 

[0045] 需要说明的是，本发明的第一步中涉及的所述路点坐标值的计算方式可以采用现 有坐标计算方式实现，本说明书仅对计算顺序步骤作一说明，对具体的计算公式则不再详 细说明了，本领域普通技术人员根据本说明书的描述可以实现。 [0046] 第二步：道路id转换。 

[0047] 在Apollo协议地图格式中，将道路的左右两侧分为具有不同id的两条道路，如图1 所示Road1和Road2对应OpenDrive协议中的同一条道路的两侧车道。图中的虚线部分为车 道中心线；实线为车道边界线；箭头表示道路方向。根据OpenDrive中提供的道路id信息转 换到Apollo格式中需要将其左右两侧车道分别拆为两条道路并赋予新的道路id。例如当前 OpenDrive协议格式地图中待转换道路的id＝n，将其转换到Apollo协议地图中则其左右两 侧车道需变成两条独立的道路并赋予新的id，左侧车道变为具有id＝n*100+1的单个道路， 右侧道路变为具有id＝n*100-1的单个道路。最后将转化后对应车道上的路点坐标集数据 存储在对应道路的id节点下，完成地图格式间基本地图元素的转换。 

[0048] 需要说明的是，OpenDrive地图中的道路号往往是连续的，由于需要把一条双向道 路转换成两条单向道路，道路号会增加，为了避免路号重复，并且能够直接根据转换后的道 路号快速推算出原始OpenDrive地图中的道路号，选用上述方法。即：原本OpenDrive地图中的一条路道路号为1，会被转换为99和101，原本道路号为2，会被转换为199和201。 

[0049] 第三步：坐标转换。 

[0050] 将OpenDrive协议格式地图采用的UTM坐标转换到WGS84(经纬度)坐标系下，以上 三种基本道路组成元素的路点计算过程均是在UTM坐标系下完成的，因此在转换成Apollo 协议地图格式前需进一步将路点坐标系转换为WGS84 ,然后按照OpenDrive协议中对道路id 的定义与Apollo协议中对道路id的定义方法，将WGS84坐标系下的路点坐标集添加到对应 的道路id下。 

[0051] 其中，在进行坐标转换过程中，需根据地图所在位置，找出当地的经纬度坐标，进 一步查找其对应经纬度的zone编号。以北京(zone 50，R)为例，将对应参数结合两种坐标系 之间的转换算法完成坐标转换。 

[0052] 第四步：道路元素拼接。 

[0053] 将各个道路元素进行拼接时，通过判断相邻道路车道中心线和车道边界线上路点 坐标值是否存在重合点，重合点的判断依据各个路点在UTM坐标系下的坐标值是否相等。如 果存在重合点，需单独将重合路点坐标删除，实现相邻道路间的无缝连接。 

[0054] 第五步：道路间拓扑关系转换。 

[0055] OpenDrive协议格式地图中对道路的描述依次为道路、道路连接关系、道路形状、 车道、车道横截面、左右侧车道信息、车道间连接关系等。而Apollo中对道路的描述依次为 道路、道路连接、车道、车道横截面、车道横截面左右边界、车道横截面左右边界点集、中心 线点集、左右车道、左右车道中心线点集。由于Apollo地图中对道路和车道信息的描述均采 用点集进行描述，即上述三部分中对道路元素路点集的计算。 

[0056] 由于两种协议的格式存在一定的差异，首先对OpenDrive协议格式的地图文件进 行信息的读取，然后将取得的信息和计算出的路点信息按照Apollo协议格式进行重新编 写，即可完成两种格式地图转换。 

[0057] 本发明提供的针对OpenDrive协议格式地图到Apollo协议格式地图的转换方法， 对现有大量OpenDrive协议格式地图在自动驾驶领域中提供了很大的应用空间，解决了现 场采集地图效率低，场景地图有限等问题，提高了高精地图应用的灵活性，以及自动驾驶车 辆在不同场景地图下的测试效率；同时节省了大量的人力采图成本和时间成本，在两种不 同协议地图之间搭建了桥梁，提高了地图应用和转换的灵活性。 

[0058] 以上所述仅是本发明的优选实施方式，应当指出的是，对于本技术领域的普通技 术人员来说，在不脱离本发明原理的前提下，还可以做出若干改进和润饰，这些改进和润饰 也应视为本发明的保护范围。

## 5 说明书附图

![image-20220507142207201](https://www.lovebetterworld.com:8443/uploads/2022/05/07/62760feca6566.png)